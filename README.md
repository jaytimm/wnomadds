wnomadds
========

An R package that provides (very unofficial) add-on functionality to the [NOMINATE-VoteView Project](https://voteview.com/)'s `wnominate` package. Functions included in the package extract/output the coordinates and angles of roll call cutting lines, ie, the data underyling plots generated by `wnominate::plot.cutlines()` and `wnominate::plot.angles()`, respectively.

`wnomadds` analogue functions are dubbed `wnm_get_cutlines()` and `wnm_get_angles()`; both functions are based on existing `wnominate` code, tweaked only to output data frames as opposed to base R plots. `wnomadds::wnm_get_cutlines()` includes the added functionality of allowing users to add arrows at the end of cutting lines to specify roll call polarity.

------------------------------------------------------------------------

Installation
------------

``` r
library(devtools)
devtools::install_github("jaytimm/wnomadds")
library(wnomadds)
```

Usage
-----

To demonstrate the functionality and utility of the `wnomadds` package, we first quickly walk through the NOMINATE ideal points estimation procedure via `wnominate` using roll call data from the **53rd Congress of the New Mexico State Legislature** made available via the `nmlegisdatr` package.

``` r
library(nmlegisdatr)#devtools::install_github("jaytimm/nmlegisdatr")
library(tidyverse)
library(wnominate)
library(pscl)
```

### Prepare data & run wnominate model

#### Reshape data for Senate roll calls

``` r
wide_rolls <- nmlegisdatr::nml_rollcall  %>%
  filter(Chamber =='House') %>%
  mutate(Bill_Unique = paste0(Bill_Code, substr(Motion, 1,1))) %>%
  dplyr::select(Representative, Bill_Unique, Member_Vote) %>%
  mutate(Member_Vote = case_when(Member_Vote == "Yea" ~ 1,
                              Member_Vote == "Nay" ~ 6,
                              Member_Vote %in% c("Excused", "Absent", "Rec") ~ 9)) %>%
  spread(key= Bill_Unique, value = Member_Vote)
```

#### Create rollcall object

``` r
roll_obj <- pscl::rollcall(wide_rolls [,-1], 
                           yea = 1,
                           nay = 6,
                           missing = 9,
                           notInLegis = NA,
                           vote.names = colnames(wide_rolls)[2:ncol(wide_rolls)], 
                           legis.names = wide_rolls$Representative)
```

#### Build model

``` r
ideal_2d <- wnominate::wnominate (roll_obj, 
                                  ubeta=15, 
                                  uweights=0.5, 
                                  dims=2, 
                                  minvotes=20,
                                  lop=0.025,
                                  trials=3, 
                                  polarity=c(1,1),
                                  verbose=FALSE)
## 
## Preparing to run W-NOMINATE...
## 
##  Checking data...
## 
##      All members meet minimum vote requirements.
## 
##      Votes dropped:
##      ... 612 of 803 total votes dropped.
## 
##  Running W-NOMINATE...
## 
##      Getting bill parameters...
##      Getting legislator coordinates...
##      Starting estimation of Beta...
##      Getting bill parameters...
##      Getting legislator coordinates...
##      Starting estimation of Beta...
##      Getting bill parameters...
##      Getting legislator coordinates...
##      Getting bill parameters...
##      Getting legislator coordinates...
##      Estimating weights...
##      Getting bill parameters...
##      Getting legislator coordinates...
##      Estimating weights...
##      Getting bill parameters...
##      Getting legislator coordinates...
## 
## 
## W-NOMINATE estimation completed successfully.
## W-NOMINATE took 8.36 seconds to execute.
```

``` r
row.names(ideal_2d$rollcalls) <- colnames(wide_rolls)[2:ncol(wide_rolls)]
```

#### Extract legislators coordinates from `nomObj` object

``` r
house_data <- ideal_2d$legislators %>% 
  bind_cols(nml_legislators %>% 
              filter(Chamber == 'House')) 
```

### wnomadds::get\_cutlines()

The `wnm_get_cutlines()` function returns a data frame of cutting line coordinates. The function takes a `nomObj` object and a `rollcall` object (from call to `pscl::rollcall`). If the `add_arrows` parameter is set to `TRUE`, additionally included in the data frame are coordinates of points perpendicular to cutting line ends in the direction of maximum Yea's (per roll call). The distance between these points and the cutting line (ie, arrow length) can be specified by the `arrow_length` parameter.

``` r
with_cuts <- wnomadds::wnm_get_cutlines(ideal_2d, 
                                        rollcall_obj = roll_obj, 
                                        add_arrows = TRUE,
                                        arrow_length = 0.05)
```

#### Sample output

Output effectively contains four sets of points:

-   x\_1, y\_1: cutting line start
-   x\_2, y\_2: cutting line end
-   x\_1a, y\_1a: point perpendicular to cutting line start, `arrow_length` away in the direction of max Yea's
-   x\_2a, y\_2a: point perpendicular to cutting line end, `arrow_length` away in the direction of max Yea's

``` r
head(with_cuts)
##      Bill_Code         x_1        y_1        x_2       y_2        x_1a
## 1: R17_HB0002P -0.03440052 -0.9994081 -0.4603719 0.8877261 -0.12875723
## 2: R17_HB0004P  0.41486696 -0.9098821 -0.2527293 0.9675370  0.32099600
## 3: R17_HB0005P  0.01817059 -0.9998349 -0.4126599 0.9108852 -0.07736541
## 4: R17_HB0011P  0.34721723 -0.9377847 -0.4093959 0.9123568  0.25471015
## 5: R17_HB0016P -0.86381566 -0.5038080 -0.9083194 0.4182773 -0.81771139
## 6: R17_HB0017P -0.85902368 -0.5119359 -0.8954449 0.4451723 -0.81116827
##          y_1a       x_2a      y_2a
## 1: -1.0207067 -0.5547286 0.8664276
## 2: -0.9432619 -0.3466002 0.9341572
## 3: -1.0213764 -0.5081959 0.8893437
## 4: -0.9756154 -0.5019030 0.8745262
## 5: -0.5015828 -0.8622151 0.4205024
## 6: -0.5101148 -0.8475895 0.4469934
```

#### Plot legislator coordinates & cutting lines with arrows indicating polarity

The four sets of points included in the output of `wnomadds::get_cutlines` can be used to create three line segments via `geom_plot`: cutting start to cutting end, cutting start to opposite arrow, and cutting end to opposite arrow.

``` r
ggplot () + 
  wnomadds::scale_color_party() +
  theme(legend.position = 'bottom') +
          annotate("path",
               x=cos(seq(0,2*pi,length.out=300)),
               y=sin(seq(0,2*pi,length.out=300)),
               color='lightgray',
               size = .25) +
  geom_point(data=house_data, 
               aes(x=coord1D, y=coord2D,color = Party),
               size= 3, 
               shape= 17) +
  geom_segment(data=with_cuts, 
               aes(x = x_1, y = y_1, xend = x_2, yend = y_2)) + #cutting start to end
  geom_segment(data=with_cuts, 
               aes(x = x_2, y = y_2, xend = x_2a, yend = y_2a), #cutting end to opposite arrow
               arrow = arrow(length = unit(0.2,"cm"))) +
  geom_segment(data=with_cuts, 
               aes(x = x_1, y = y_1, xend = x_1a, yend = y_1a), #cutting start to opposite arrow
               arrow = arrow(length = unit(0.2,"cm")))+
  geom_text(data=with_cuts, 
               aes(x = x_1a, y = y_1a, label = Bill_Code), 
               size=2.5, 
               nudge_y = 0.03,
               check_overlap = TRUE) +
  coord_fixed(ratio=1) + 
  labs(title="Lower chamber: Cutting lines & legislator coordinates")
```

![](figure-markdown_github/unnamed-chunk-12-1.png)

#### Select some example cutting lines

``` r
#select_cuts <- with_cuts$Bill_Code[112:123]
select_cuts <- c('R18_HB0079', 'R17_HB0442', 'R17_HB0017',
                 'R17_HB0086', 'R17_HB0125', 'R17_HB0138')

sub <- nmlegisdatr::nml_rollcall %>%
  filter(Bill_Code %in% select_cuts) %>%
  inner_join(house_data) %>%
  inner_join(nml_legislation) 

cut_sub <- subset(with_cuts, Bill_Code %in% paste0(select_cuts,'P')) %>%
  mutate(Bill_Code = gsub('.$', '', Bill_Code)) %>%
  inner_join(nml_legislation) 
```

#### Facet plot of multiple cutting lines

``` r
sub %>%
ggplot(aes(x=coord1D, y=coord2D)) +
        annotate("path",
               x=cos(seq(0,2*pi,length.out=300)),
               y=sin(seq(0,2*pi,length.out=300)),
               color='lightgray',
               size = .25) +
  geom_point(aes(color = Party_Member_Vote, 
                 shape= Party_Member_Vote, 
                 fill = Party_Member_Vote),
             size= 1.5) +
  wnomadds::scale_color_rollcall() +
  wnomadds::scale_fill_rollcall() +
  wnomadds::scale_shape_rollcall() +
  theme(legend.position = 'bottom') +
  geom_text(aes(label=Representative), 
            size=1.75, 
            check_overlap = TRUE, 
            hjust = "inward",
            nudge_y = -0.03)+
  coord_fixed() +
  geom_segment(data=cut_sub, 
               aes(x = x_1, y = y_1, xend = x_2, yend = y_2)) +
  geom_segment(data=cut_sub, 
               aes(x = x_2, y = y_2, xend = x_2a, yend = y_2a), 
               arrow = arrow(length = unit(0.2,"cm"))) +
  geom_segment(data=cut_sub, 
               aes(x = x_1, y = y_1, xend = x_1a, yend = y_1a), 
               arrow = arrow(length = unit(0.2,"cm")))+
  geom_text(data=cut_sub, 
               aes(x = .7, y = -1, label = Bill_Code), 
               size=2.25, 
               nudge_y = 0.1,
               check_overlap = TRUE) +
  labs(title="Lower chamber: Selected roll calls & cutting lines") +
  facet_wrap(~Bill_Title, labeller = label_wrap_gen(), ncol = 3) +
  theme(strip.text = element_text(size=7))
```

![](figure-markdown_github/unnamed-chunk-14-1.png)

### wnomadds::get\_angles()

Cutting line angles can be extracted from a `nomObj` object using `wnomadds::wnm_get_angles()`. Output is a simple data frame.

``` r
angles <- wnomadds::wnm_get_angles(ideal_2d)
head(angles)
##     Bill_Code     angle
## 1 R17_HB0002P 102.71986
## 2 R17_HB0004P 109.57501
## 3 R17_HB0005P 102.70660
## 4 R17_HB0011P 112.24205
## 5 R17_HB0016P  92.76319
## 6 R17_HB0017P  92.17925
```
